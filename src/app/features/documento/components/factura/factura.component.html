<div class="proforma-container">
  <div class="header">
    <h2>Fatura</h2>
  <button class="save-btn" (click)="salvarFatura()" [disabled]="isLoading">
  <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
  {{ isLoading ? 'Salvando...' : 'Salvar Fatura' }}
</button>



  </div>

 <div class="card shadow-sm border-0 mb-4 p-3">

 <div class="mb-3">
  <label class="form-label">Cliente</label>
  <div class="dropdown w-100">
    <button
      class="btn btn-light border w-100 text-start d-flex justify-content-between align-items-center"
      type="button"
      data-bs-toggle="dropdown"
      aria-expanded="false"
      [ngClass]="{ 'is-invalid': clienteCtrl.invalid && clienteCtrl.touched }"
    >
      <span *ngIf="clienteSelecionado; else placeholder">
        <i class="bi bi-person-fill text-primary me-2"></i>
        {{ clienteSelecionado.nome }}
      </span>
      <ng-template #placeholder>
        <span class="text-muted">Selecione o cliente</span>
      </ng-template>
      <i class="bi bi-chevron-down ms-auto"></i>
    </button>

    <ul class="dropdown-menu w-100 shadow-sm">
      <li
        *ngFor="let c of cliente"
        class="dropdown-item d-flex align-items-center"
        (click)="clienteSelecionado = c"
      >
        <i class="bi bi-person-fill text-primary me-2"></i> {{ c.nome }}
      </li>
    </ul>
  </div>

  <input
    type="hidden"
    name="clienteSelecionado"
    [(ngModel)]="clienteSelecionado"
    #clienteCtrl="ngModel"
    required
  />
  <div *ngIf="clienteCtrl.invalid && clienteCtrl.touched" class="text-danger">
    Selecione um cliente válido.
  </div>
</div>

  <div class="row text-muted">
    <div class="col-md-6">
      <p class="mb-1"><strong>Nº da Fatura:</strong> {{ numeroFatura }}</p>
    </div>
    <div class="col-md-6">
      <p class="mb-1"><strong>Data de Validade:</strong> {{ dataValidadeFormatada }} </p>

    </div>
  </div>
</div>

  <div *ngIf="clienteSelecionado" class="card-info">
  <h4>Dados do Cliente</h4>
  <p><strong>Nome:</strong> {{ clienteSelecionado.nome }}</p>
  <p><strong>Email:</strong> {{ clienteSelecionado.email }}</p>
  <p><strong>Telefone:</strong> {{ clienteSelecionado.telefone }}</p>
  <p><strong>Endereço:</strong> {{ clienteSelecionado.endereco }}</p>

</div>

  <table class="items-table">
    <thead>
      <tr>
        <th>#</th>
        <th>Categoria</th>
        <th>Produto/Serviço</th>
        <th>Preço un.</th>
        <th>Qtd.</th>
        <th>Total</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let item of itens; let i = index; trackBy: trackByFn" >
        <td>{{ i + 1 }}</td>

     <!-- Categoria -->
<td>
  <select [(ngModel)]="item.categoriaId" (change)="onCategoriaChange(item)" #categoriaCtrl="ngModel" required>
    <option [ngValue]="null">Selecione...</option>
    <option *ngFor="let categoria of categorias" [ngValue]="categoria.id">{{ categoria.nome }}</option>
  </select>
  <div *ngIf="categoriaCtrl.invalid && categoriaCtrl.touched" class="text-danger">
    Selecione uma categoria.
  </div>
</td>

<!-- Artigo -->
<td>
  <select
    [(ngModel)]="item.artigoId"
    (change)="onArtigoChange(item)"
    #artigoCtrl="ngModel"
    required
    [disabled]="!item.categoriaId"> <!-- Aqui -->
    <option [ngValue]="null">Selecione...</option>
    <option *ngFor="let artigo of getArtigosFiltradosPorCategoria(item.categoriaId)" [ngValue]="artigo.id">{{ artigo.nome }}</option>
  </select>
  <div *ngIf="artigoCtrl.invalid && artigoCtrl.touched" class="text-danger">
    Selecione um artigo.
  </div>
</td>


        <!-- Preço unitário -->
     <td>{{ (item.artigoSelecionado?.preco ?? 0) | number:'1.2-2' }} Kz</td>


        <!-- Quantidade com botões + / - -->
   <td>
  <button (click)="atualizarQuantidade(item, -1)" [disabled]="item.quantidade <= 1">−</button>
  <span class="qty-display">{{ item.quantidade }}</span>
  <button (click)="atualizarQuantidade(item, 1)">+</button>
</td>


        <!-- Total -->
        <td>{{ item.total | number:'1.2-2' }} Kz</td>

        <!-- Ações (remover, expandir etc.) -->
        <td>
          <button (click)="removerItem(i)"><i class="bi bi-trash"></i></button>


        </td>
      </tr>
    </tbody>
  </table>

  <!-- Adicionar novo item -->
  <div class="add-item-btn">
    <button (click)="adicionarItem()">
      <i class="bi bi-plus-circle"></i> Adicionar um item
    </button>
  </div>

  <!-- Desconto -->
  <div class="desconto-section">
    <label for="desconto">Desconto (%):</label>
    <input
      id="desconto"
      type="number"
      [(ngModel)]="desconto"
      (input)="recalcularTotais()"
      min="0"
      max="100"
    />
  </div>

<div class="summary">
  <div><span>Subtotal:</span><span>{{ subtotal | number:'1.2-2' }} Kz</span></div>
  <div><span>Imposto:</span><span>{{ iva | number:'1.2-2' }} Kz</span></div>
  <div><span>Desconto:</span><span>{{ descontoValor | number:'1.2-2' }} Kz</span></div>
  <div class="total"><span>Total:</span><span>{{ totalGeral | number:'1.2-2' }} Kz</span></div>
</div>

</div>
